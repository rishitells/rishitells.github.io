{"componentChunkName":"component---src-templates-blog-post-js","path":"/setting-up-gitlab-ci-with-jest/","result":{"data":{"site":{"siteMetadata":{"title":"rishitells"}},"markdownRemark":{"id":"6788b1b6-2e5e-526f-a586-9b1facdd3c36","excerpt":"For teams doing continuous integration delivery of software projects, running unit/integration tests in automated pipelines becomes essential for ensuring…","html":"<p>For teams doing continuous integration delivery of software projects, running unit/integration tests in automated pipelines becomes essential for ensuring correctness and quality of code. GitLab provides an easy-to-configure automated pipelines setup which we can utilise to run anything before deploying to environments. In this article, we’ll setup automated tests and coverage reports for JavaScript projects using the <a href=\"http://jestjs.io\">Jest testing framework</a>.</p>\n<h3>1. Add GitLab CI configuration file in the root</h3>\n<p>In the root of your project, add <code class=\"language-text\">.gitlab-ci.yml</code> with the configuration below.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> node<span class=\"token punctuation\">:</span>latest\n\n<span class=\"token key atrule\">stages</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> build\n  <span class=\"token punctuation\">-</span> test\n\n<span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> build\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> yarn\n  <span class=\"token key atrule\">cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> node_modules/\n  <span class=\"token key atrule\">artifacts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">expire_in</span><span class=\"token punctuation\">:</span> 1 days\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> on_success\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> node_modules/\n\n<span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> test\n  <span class=\"token key atrule\">coverage</span><span class=\"token punctuation\">:</span> /All files<span class=\"token punctuation\">[</span>^<span class=\"token punctuation\">|</span><span class=\"token punctuation\">]</span><span class=\"token important\">*\\|</span><span class=\"token punctuation\">[</span>^<span class=\"token punctuation\">|</span><span class=\"token punctuation\">]</span><span class=\"token important\">*\\s+(</span><span class=\"token punctuation\">[</span>\\d\\.<span class=\"token punctuation\">]</span>+)/\n  <span class=\"token key atrule\">dependencies</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> build\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> yarn test<span class=\"token punctuation\">:</span>ci\n  <span class=\"token key atrule\">artifacts</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">reports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">junit</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> junit.xml\n      <span class=\"token key atrule\">cobertura</span><span class=\"token punctuation\">:</span> coverage/cobertura<span class=\"token punctuation\">-</span>coverage.xml</code></pre></div>\n<p>Note that We have cached the <code class=\"language-text\">node_modules/</code> in build stage to make them available for subsequent jobs without having to download them again.</p>\n<p>Pushing this to GitLab will automatically trigger the CI build. But before that, we’ll add the required packages/configuration so that the build passes.</p>\n<h3>2. Install <code class=\"language-text\">jest-junit</code> package for reporting of tests</h3>\n<p>Next, we’ll configure jest-junit, which will generate JUnit report format XML file (<code class=\"language-text\">junit.xml</code>) in the project root. GitLab will parse this XML format and then these reports can be viewed inside the pipelines details page, and also in the reports panel in Merge Requests. See the <a href=\"https://docs.gitlab.com/ee/ci/unit_test_reports.html#how-it-works\">GitLab Unit test reports</a> docs for more details.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save-dev jest-junit</code></pre></div>\n<p>OR</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">yarn</span> <span class=\"token function\">add</span> --dev jest-junit</code></pre></div>\n<h3>3. Add <code class=\"language-text\">coverageReporters</code> and other required config to <code class=\"language-text\">jest.config.js</code></h3>\n<p>From the GitLab Docs -</p>\n<blockquote>\n<p>Collecting the coverage information is done via GitLab CI/CD’s artifacts reports feature. You can specify one or more coverage reports to collect, including wildcard paths. GitLab then takes the coverage information in all the files and combines it together.</p>\n<p>For the coverage analysis to work, you have to provide a properly formatted Cobertura XML report to artifacts:reports:cobertura.</p>\n</blockquote>\n<p>So we need to add Cobertura coverage reporter in <code class=\"language-text\">jest.config.js</code> for test coverage in GitLab Merge Requests</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"collectCoverageFrom\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"src/**/*.js\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"!**/node_modules/**\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"coverageReporters\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"html\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"text-summary\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"cobertura\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"testMatch\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"**/*.test.js\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Adding <code class=\"language-text\">cobertura</code> to <code class=\"language-text\">coverageReporters</code> will generate <code class=\"language-text\">cobertura-coverage.xml</code> inside <code class=\"language-text\">/coverage/</code> folder created by Jest, and will be parsed by GitLab.</p>\n<h3>4. Add CI test run script to <code class=\"language-text\">package.json</code> with jest-junit reporter</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"test:ci\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"jest --config ./jest.config.js --collectCoverage --coverageDirectory=\\\"./coverage\\\" --ci --reporters=default --reporters=jest-junit --watchAll=false\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This script is used in the <code class=\"language-text\">test</code> stage in the <code class=\"language-text\">.gitlab-ci.yaml</code> file we created in step 1.</p>\n<h3>5. Modify GitLab Project CI/CD settings for test coverage parsing</h3>\n<p>Go to Project > Settings > CI/CD > General pipelines > Test coverage parsing\nAdd the following RegEx -</p>\n<p><code class=\"language-text\">Lines\\s*:\\s*(\\d+.?\\d*)%</code></p>\n<p>This regular expression is used to find test coverage output in the job log. This coverage % can be viewed on Project > CI/CD > Jobs. We can also configure Badges on Project Overview page to show coverage % (see next step).</p>\n<p>Finally, push all the changes to GitLab and you should see your pipeline up and running.\nAlso in the subsequent Merge Requests, you should see the number of tests, failing tests (if any) and failure reason, and test coverage information infiles.</p>\n<h3>6. Show Pipeline and Coverage Badge on the Project Overview page</h3>\n<p>We can add Badges to the overview page of GitLab projects to display useful information such as pipeline status, current release version, test coverage percentage etc. Below is how we can configure and add Badges -</p>\n<p><a href=\"https://docs.gitlab.com/ee/user/project/badges.html#project-badges\">From GitLab Docs:</a></p>\n<blockquote>\n<p>To add a new badge to a project:</p>\n<ol>\n<li>Navigate to your project’s Settings > General > Badges.</li>\n<li>Under “Link”, enter the URL that the badges should point to and under “Badge image URL” the URL of the image that should be displayed.</li>\n<li>Submit the badge by clicking the Add badge button.</li>\n</ol>\n<h3>Example project badge: Pipeline Status</h3>\n<p>A common project badge presents the GitLab CI pipeline status.</p>\n<p>To add this badge to a project:</p>\n<ol>\n<li>Navigate to your project’s Settings > General > Badges.</li>\n<li>Under Name, enter Pipeline Status.</li>\n<li>Under Link, enter the following URL: <a href=\"https://gitlab.com/%25%7Bproject_path%7D/-/commits/%25%7Bdefault_branch%7D\">https://gitlab.com/%{project_path}/-/commits/%{default_branch}</a></li>\n<li>Under Badge image URL, enter the following URL: <a href=\"https://gitlab.com/%25%7Bproject_path%7D/badges/%25%7Bdefault_branch%7D/pipeline.svg\">https://gitlab.com/%{project_path}/badges/%{default_branch}/pipeline.svg</a></li>\n<li>Submit the badge by clicking the Add badge button.</li>\n</ol>\n</blockquote>\n<p>In the similar way, we can add a <code class=\"language-text\">coverage</code> badge to project. Just replace <code class=\"language-text\">pipeline.svg</code> with <code class=\"language-text\">coverage.svg</code> in step 4 above.</p>\n<h3>7. Publish Jest Coverage Report to GitLab pages</h3>\n<p>We can publish our Jest coverage report (<code class=\"language-text\">.html</code>) to GitLab pages to view detailed Jest coverage report on a GitLab Pages URL.</p>\n<p>To publish - modify <code class=\"language-text\">.gitlab-ci.yml</code> to add deploy stage for publishing the coverage report HTML to GitLab pages</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">image: node:latest\n\nstages:\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> - build\n<span class=\"token prefix unchanged\"> </span> - test\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span> - deploy\n</span>\nbuild:\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> stage: build\n<span class=\"token prefix unchanged\"> </span> script:\n<span class=\"token prefix unchanged\"> </span>   - yarn\n<span class=\"token prefix unchanged\"> </span> cache:\n<span class=\"token prefix unchanged\"> </span>   paths:\n<span class=\"token prefix unchanged\"> </span>     - node_modules/\n<span class=\"token prefix unchanged\"> </span> artifacts:\n<span class=\"token prefix unchanged\"> </span>   expire_in: 1 days\n<span class=\"token prefix unchanged\"> </span>   when: on_success\n<span class=\"token prefix unchanged\"> </span>   paths:\n<span class=\"token prefix unchanged\"> </span>     - node_modules/\n</span>\ntest:\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> stage: test\n<span class=\"token prefix unchanged\"> </span> coverage: /All files[^|]*\\|[^|]*\\s+([\\d\\.]+)/\n<span class=\"token prefix unchanged\"> </span> dependencies:\n<span class=\"token prefix unchanged\"> </span>   - build\n<span class=\"token prefix unchanged\"> </span> script:\n<span class=\"token prefix unchanged\"> </span>   - yarn test:ci\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span> cache:\n<span class=\"token prefix inserted\">+</span>   paths:\n<span class=\"token prefix inserted\">+</span>     - coverage/\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> artifacts:\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>   paths:\n<span class=\"token prefix inserted\">+</span>     - coverage/\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   when: always\n<span class=\"token prefix unchanged\"> </span>   reports:\n<span class=\"token prefix unchanged\"> </span>     junit:\n<span class=\"token prefix unchanged\"> </span>       - junit.xml\n<span class=\"token prefix unchanged\"> </span>     cobertura: coverage/cobertura-coverage.xml\n</span>\n<span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span> pages:\n<span class=\"token prefix inserted\">+</span>  stage: deploy\n<span class=\"token prefix inserted\">+</span>  dependencies:\n<span class=\"token prefix inserted\">+</span>    - test\n<span class=\"token prefix inserted\">+</span>  script:\n<span class=\"token prefix inserted\">+</span>    - mkdir .public\n<span class=\"token prefix inserted\">+</span>    - cp -r coverage/* .public\n<span class=\"token prefix inserted\">+</span>    - mv .public public\n<span class=\"token prefix inserted\">+</span>  artifacts:\n<span class=\"token prefix inserted\">+</span>    paths:\n<span class=\"token prefix inserted\">+</span>      - public\n<span class=\"token prefix inserted\">+</span>  only:\n<span class=\"token prefix inserted\">+</span>    - master</span></code></pre></div>\n<p>After pushing the changes, when the deploy step is successful in pipeline, We can access the Jest coverage report page using the URL mentioned in <code class=\"language-text\">Project &gt; Settings &gt; Pages</code>.</p>\n<p>Each time the deploy job runs, a new coverage report will be published to the GitLab pages URL. Note that we have published coverage report to Pages only for <code class=\"language-text\">master</code> branch, because we don’t want all branch commits to publish coverage report.</p>\n<h2>References</h2>\n<ol>\n<li><a href=\"https://docs.gitlab.com/ee/ci/quick_start/#cicd-process-overview\">GitLab CI/CD process overview - GitLab Docs</a></li>\n<li><a href=\"https://docs.gitlab.com/ee/ci/unit_test_reports.html\">Unit test reports - GitLab Docs</a></li>\n<li><a href=\"https://docs.gitlab.com/ee/user/project/merge_requests/test_coverage_visualization.html\">Test Coverage Visualization - GitLab Docs</a></li>\n<li><a href=\"https://javascript.plainenglish.io/how-to-display-code-coverage-of-a-vue-project-in-gitlab-9d1510a3e794\">How to display code coverage of a Vue project in Gitlab</a></li>\n</ol>","frontmatter":{"title":"Setting up Jest tests and coverage in GitLab CI","date":"July 04, 2021","description":"Configuring Jest Tests in GitLab CI"}},"previous":null,"next":null},"pageContext":{"id":"6788b1b6-2e5e-526f-a586-9b1facdd3c36","previousPostId":null,"nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}